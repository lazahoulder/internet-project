{% extends 'base.html.twig' %}

{% block title %}Hello TeamController!{% endblock %}

{% block body %}
    <div class="container" x-data="teams()" x-init="retrieveTeam()">
        <div class="row">
            <div class="col-sm-9">
                <h3 x-text="headerTitle"></h3>
            </div>
            <div class="col-sm-3">
                <button x-show="showList" type="button" class="btn btn-primary" @click="openForm()">
                    <i class="fa fa-plus"></i>
                    &nbsp;New team
                </button>
            </div>
        </div>
        <div class="row" x-show="showList">
            <table class="table" >
                <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Country</th>
                    <th scope="col">Acount balance</th>
                    <th scope="col">Action</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="team in teams">
                    <tr>
                        <td x-text="team.name"></td>
                        <td x-text="team.country"></td>
                        <td x-text="team.acountBalance"></td>
                        <td class="text-right">
                            <div class="hidden-sm hidden-xs btn-group">
                                <button class="btn btn-xs btn-info">
                                    <i class="ace-icon fa fa-eye bigger-120"></i>
                                </button>
                                <button class="btn btn-xs btn-secondary" @click="editTeam(team.id)">
                                    <i class="ace-icon fa fa-edit bigger-120"></i>
                                </button>
                                <button class="btn btn-xs btn-danger"
                                        @click="removeTeam(team.id)">
                                    <i class="ace-icon fa fa-close bigger-120"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
        <div class="row" x-show="showForm">
            <div class="col-sm-12">
                <form @submit.prevent="submitForm()">
                    <div class="mb-3">
                        <label for="nameInput" class="form-label">Name</label>
                        <input type="text" class="form-control" id="nameInput" x-model="formData.name">
                    </div>
                    <div class="mb-3">
                        <label for="countryInput" class="form-label">Country</label>
                        <input type="text" class="form-control" id="countryInput" x-model="formData.country">
                    </div>
                    <div class="mb-3">
                        <label for="balanceInput" class="form-label">Balance</label>
                        <input type="text" class="form-control" id="balanceInput" x-model="formData.acountBalance">
                        <div x-show="isNaN(formData.acountBalance)" class="form-text text-danger">This value is not valid</div>
                    </div>
                    <button class="btn btn-primary" @click.prevent="closeForm()">
                        <i class="fa fa-close"></i>
                        &nbsp;Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
    <script type="application/javascript">
        function teams() {
            return {
                teams: [],
                showList: true,
                headerTitle: 'Teams',
                uri: '{{ path('api_team_list') }}',
                showForm:false,
                editData: false,
                editId: null,
                formData: {
                    name: "",
                    country: "",
                    acountBalance: 0,
                },

                openForm(header = 'New team') {
                    this.showList = false;
                    this.showForm = true;
                    this.headerTitle = header;
                },

                closeForm() {
                    this.showList = true;
                    this.showForm = false;
                    this.headerTitle = 'Teams';
                },

                initFormData(team = null) {
                    if (team) {
                        this.formData.name = team.name;
                        this.formData.country = team.country;
                        this.formData.acountBalance = team.acountBalance;
                    } else {
                        this.formData = {
                            name: "",
                            country: "",
                            acountBalance: 0,
                        };
                    }

                    this.editData = false;
                },

                editTeam(teamId) {
                    this.openForm('Update Team');
                    let team = this.teams.find(elt => elt.id === teamId);
                    this.editId = teamId;
                    this.initFormData(team);
                    this.editData = true;
                },

                async updateTeam() {
                    this.formData.acountBalance = parseInt(this.formData.acountBalance);
                    let uri = this.uri+this.editId;
                    await fetch(uri, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify(this.formData),
                    })
                        .then(() => {
                            this.closeForm();
                            this.retrieveTeam();
                        })
                        .catch(() => {
                            this.formMessage = "Something went wrong.";
                        });
                },

                submitForm() {
                    if (this.editData) {
                        this.updateTeam();
                    } else {
                        this.addTeam();
                    }
                },

                async retrieveTeam(uri = this.uri) {
                    this.teams = await (await fetch(uri)).json()
                },

                async removeTeam(teamId) {
                    let uri = this.uri + teamId;

                    await fetch(uri, {
                        method: 'DELETE',
                    }).then(() => {
                        this.retrieveTeam();
                    });
                },

                async addTeam() {
                    this.formData.acountBalance = parseInt(this.formData.acountBalance);
                    await fetch(this.uri, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify(this.formData),
                    })
                        .then(() => {
                            this.closeForm();
                            this.retrieveTeam();
                        })
                        .catch(() => {
                            this.formMessage = "Something went wrong.";
                        });
                },
            }
        }
    </script>
{% endblock %}
